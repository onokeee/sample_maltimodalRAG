# 🎨 マルチモーダル機能ガイド

## ✨ 新機能: 文章中に画像を埋め込んで回答

### 🆕 v2.1の新機能

従来は画像が**文章の下**に表示されていましたが、v2.1では**文章中の適切な位置**に画像を埋め込んで回答します。

#### 従来版（v2.0）
```
回答テキスト回答テキスト回答テキスト...

---
【関連画像】
[画像1] [画像2] [画像3]
```

#### マルチモーダル版（v2.1）🆕
```
この図は〇〇を示しています。

[ここに画像1が埋め込まれる]

次に、△△について説明します。

[ここに画像2が埋め込まれる]

このように...
```

---

## 🚀 使い方

### 起動方法

```cmd
# マルチモーダル版を起動
start_multimodal.bat
```

または、仮想環境を有効化してから：

```cmd
streamlit run app_multimodal.py
```

---

## ⚙️ 設定

### サイドバーの「回答モード」で切り替え

#### マルチモーダルモード（推奨）🆕
- ✅ GPT-4 Visionが画像を理解
- ✅ 文章中の適切な位置に画像を埋め込み
- ✅ 画像の内容を参照した詳細な説明
- ❌ API使用量が多い

#### 通常モード
- ✅ 高速
- ✅ API使用量が少ない
- ❌ 画像は文章の下に一括表示
- ❌ 画像の内容は参照されない

---

## 📝 使用例

### 例1: 図表の説明を求める

**質問:**
```
このグラフは何を示していますか？
```

**マルチモーダルモードの回答:**
```
このグラフは売上推移を示しています。

[グラフ画像がここに表示]

2024年第1四半期から第4四半期にかけて、
売上が30%増加していることが分かります。
特に第3四半期に大きな伸びが見られます。
```

**通常モードの回答:**
```
ドキュメントによると、売上推移を示すグラフです。
2024年の四半期ごとの売上データが記載されています。

---
【関連画像】
[グラフ画像]
```

### 例2: 複数の画像を参照

**質問:**
```
図1と図2の違いを説明してください
```

**マルチモーダルモードの回答:**
```
図1は旧システムの構成を示しています。

[図1がここに表示]

一方、図2は新システムの構成です。

[図2がここに表示]

主な違いは、新システムではクラウド基盤を
採用している点です。
```

---

## 🎯 どちらを使うべきか

### マルチモーダルモードが向いている場合
- ✅ 図表やグラフの詳細な説明が必要
- ✅ 複数の画像を比較したい
- ✅ 画像の内容を理解した回答が欲しい
- ✅ API使用料を気にしない

### 通常モードが向いている場合
- ✅ テキスト中心のドキュメント
- ✅ 画像は参考程度でOK
- ✅ 高速な応答が必要
- ✅ API使用料を節約したい

---

## 🔧 仕組み

### マルチモーダルモードの処理フロー

1. **検索**: RAGで関連するドキュメントと画像を検索
2. **画像理解**: GPT-4 Visionに画像を送信
3. **回答生成**: 画像の内容を理解した上で回答を生成
4. **画像埋め込み**: 「[画像1]」などの参照を実際の画像に置換
5. **表示**: 文章と画像が統合された形で表示

### 技術スタック

- **LLM**: GPT-4o-mini（マルチモーダル対応）
- **画像エンコード**: Base64
- **テキスト解析**: 正規表現で画像参照を検出
- **レンダリング**: Streamlitで画像と文章を統合表示

---

## 📊 パフォーマンス比較

| 項目 | 通常モード | マルチモーダル |
|-----|-----------|--------------|
| 処理速度 | ⚡ 高速 | 🐢 やや遅い |
| 画像理解 | ❌ なし | ✅ あり |
| 回答品質 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| API使用量 | 💰 少ない | 💰💰 多い |
| 画像表示 | 文章の下 | 文章中 |

---

## 🐛 トラブルシューティング

### エラー: "API rate limit exceeded"
**原因**: マルチモーダルモードはAPI使用量が多い

**解決策**:
1. 通常モードに切り替え
2. APIキーの使用量制限を確認
3. 検索結果件数を減らす（3→1）

### 画像が表示されない
**原因**: 画像IDの解析エラー

**解決策**:
1. インデックスを再作成
2. ログを確認（📊 システム情報タブ）
3. 画像キャッシュをクリア（リセット）

### 回答に画像参照がない
**原因**: LLMが画像を言及しなかった

**対策**:
- 質問を具体的に（「この図は？」→「図1は何を示していますか？」）
- 検索結果件数を増やす
- 画像抽出方法を「高品質」に変更

---

## 💡 Tips

### 効果的な質問の仕方

❌ **悪い例:**
```
このドキュメントについて教えて
```

✅ **良い例:**
```
2ページ目のフローチャートについて、
各ステップを詳しく説明してください
```

### 画像を確実に参照させる

- 「図」「グラフ」「画像」などのキーワードを含める
- ページ番号を指定する
- 「比較して」「違いを」などの指示を加える

---

## 📚 関連ドキュメント

- `IMPROVEMENTS.md` - 改善内容詳細
- `IMPLEMENTATION_REPORT.md` - 実装レポート
- `README.md` - 基本的な使い方

---

**マルチモーダルモードで、より賢い回答を体験してください！🎨**
